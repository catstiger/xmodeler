var ActivityEngine=function(a){if(!a.menu)a.menu=new ContextMenu(this,[{className:"start-event",action:"StartEvent",text:"\u5f00\u59cb\u4e8b\u4ef6"},{className:"end-event",action:"EndEvent",text:"\u7ed3\u675f\u4e8b\u4ef6"},{className:"user-task",action:"UserTask",text:"\u7528\u6237\u4efb\u52a1"},{className:"connection",action:"",text:"\u8fde\u63a5\u7ebf"},{className:"sp",action:"",text:""},{className:"delete",action:"",text:"\u5220\u9664"}]);ActivityEngine.superClass.constructor.call(this,a)};
Q.inherit(ActivityEngine,Engine);ActivityEngine.prototype.addUserTask=function(a,b){return this._addAcitivty("UserTask",a,b)};ActivityEngine.prototype.addServiceTask=function(a,b){return this._addAcitivty("ServiceTask",a,b)};ActivityEngine.prototype.addScriptTask=function(a,b){return this._addAcitivty("ScriptTask",a,b)};ActivityEngine.prototype.addSubProcess=function(a,b){return this._addAcitivty("SubProcess",a,b)};
ActivityEngine.prototype.addParallelGateway=function(a,b){return this._addAcitivty("ParallelGateway",a,b)};ActivityEngine.prototype.addExclusiveGateway=function(a,b){return this._addAcitivty("ExclusiveGateway",a,b)};ActivityEngine.prototype.addEndEvent=function(a,b){return this._addAcitivty("EndEvent",a,b)};ActivityEngine.prototype.addStartEvent=function(a,b){return this._addAcitivty("StartEvent",a,b)};
ActivityEngine.prototype.addErrorEndEvent=function(a,b){return this._addAcitivty("ErrorEndEvent",a,b)};ActivityEngine.prototype.addTimerEvent=function(a,b){return this._addAcitivty("TimerEvent",a,b)};ActivityEngine.prototype.addShadowFlow=function(a,b,c){if(b&&b.canBeConnected)a||(a={}),a.connectionCreated=function(a){a.id=Quark.UIDUtil.createUID("sequenceFlow");a.rawType="SequenceFlow";a.rawObject=SequenceFlow.prototype.rawObject},ActivityEngine.superClass.addShadowFlow.call(this,a,b,c)};
ActivityEngine.prototype.addSequenceFlow=function(a){var b={x:0,y:0,autoSize:!0};Q.merge(b,a);b=SequenceFlow.create(b);a.startNode&&a.startNode.parent.addChild(b);return b};
ActivityEngine.prototype.rawObject=function(){if(!this.raw.process_id)this.raw.process_id="process";if(!this.raw.process_namespace)this.raw.process_namespace="http://www.activiti.org/processdef";for(var a={resourceId:this.id,properties:this.raw,stencil:{id:"BPMNDiagram"},bounds:{lowerRight:{x:this.width,y:this.height},upperLeft:{x:0,y:0}},stencilset:{url:"",namespace:"http://b3mn.org/stencilset/bpmn2.0#"},ssextensions:[]},b=[],c=this.stage.children.slice(0),e=0;e<c.length;e++)c[e].rawType=="SubProcess"&&
!c[e].maximized&&c[e].maximize();for(e=0;e<c.length;e++)Utils.isFunction(c[e].rawObject)&&b.push(c[e].rawObject());a.childShapes=b;b=this.getNodes();c={};for(e=0;e<b.length;e++)if(b[e]&&b[e].raw&&b[e].raw.defaultFlow)c[b[e].id]=b[e].raw.defaultFlow;a.properties.defaultFlowDefinitions=c;return a};var SequenceFlow=function(a){SequenceFlow.superClass.constructor.call(this,a);this.id=a.id||Quark.UIDUtil.createUID("sequenceFlow");this.rawType="SequenceFlow";this.lineColor="#898989"};Q.inherit(SequenceFlow,AbstractConnection);SequenceFlow.create=function(a){console.log(a);return new SequenceFlow(a)};
SequenceFlow.prototype.rawObject=function(){for(var a=[],b=0;b<this.points.length;b++)b==0?a.push({x:this.startNode.width/2,y:this.startNode.height/2}):b==this.points.length-1?a.push({x:this.endNode.width/2,y:this.endNode.height/2}):a.push(this.points[b]);return{resourceId:this.id,properties:{name:this.name,documentation:this.raw.documentation||"",conditionsequenceflow:this.raw.conditionsequenceflow||"",executionlisteners:this.raw.executionlisteners||{},defaultflow:this.defaultFlow||"None",conditionalflow:this.conditionFlow||
"None"},stencil:{id:this.rawType},childShapes:[],outgoing:this.getOutgoing(),bounds:this.getBounds(),dockers:a,target:{resourceId:this.endNode.id}}};var UserTask=function(a){UserTask.superClass.constructor.call(this,a);this.rawType="UserTask";this.icon=a.icon||Icons.userTask;this.name=a.name||Activity.userTask};Q.inherit(UserTask,AbstractTask);UserTask.create=function(a){var b={id:Quark.UIDUtil.createUID("userTask"),autoSize:!0,fillColor:"#5fa2dd",textColor:"#ffffff"};Q.merge(b,a);return new UserTask(b)};UserTask.prototype.resumeBorder=function(){this.border=this.active?{width:3,radius:5,color:"#FA6042"}:{width:1,radius:5,color:"#5fa2dd"}};
UserTask.prototype.setError=function(a){this.error=a};
UserTask.prototype.rawObject=function(){var a={bounds:this.getBounds(),childShapes:[],dockers:[],outgoing:this.getOutgoing(),properties:{asynchronousdefinition:this.raw.asynchronousdefinition===!0?"Yes":"No",documentation:this.raw.documentation||"",duedatedefinition:this.raw.duedatedefinition,exclusivedefinition:this.raw.exclusivedefinition===!0?"Yes":"No",formkeydefinition:this.raw.formkeydefinition||"",formproperties:this.raw.formproperties,isforcompensation:this.raw.isforcompensation||"false",
looptype:this.raw.looptype||"None",name:this.name,prioritydefinition:this.raw.prioritydefinition,tasklisteners:this.raw.tasklisteners||{},executionlisteners:this.raw.executionlisteners||{},usertaskassignment:this.raw.usertaskassignment,defaultflow:this.raw.defaultFlow},resourceId:this.id,stencil:{id:this.rawType}};if(this.error)a.error=this.error;return a};var ServiceTask=function(a){ServiceTask.superClass.constructor.call(this,a);this.rawType="ServiceTask";this.icon=a.icon||Icons.serviceTask;this.name=a.name||Activity.serviceTask};Q.inherit(ServiceTask,AbstractTask);ServiceTask.create=function(a){var b={id:Quark.UIDUtil.createUID("serviceTask"),width:120,height:60,autoSize:!0};Q.merge(b,a);return new ServiceTask(b)};
ServiceTask.prototype.rawObject=function(){return{resourceId:this.id,properties:{asynchronousdefinition:this.raw.asynchronousdefinition||"No",documentation:this.raw.documentation||"",duedatedefinition:this.raw.dueDate,exclusivedefinition:this.raw.exclusiveDefinition||"Yes",isforcompensation:this.raw.isforcompensation||"false",looptype:this.raw.looptype||"None",name:this.name,prioritydefinition:this.raw.prioritydefinition,tasklisteners:this.raw.taskListeners||{},executionlisteners:this.raw.executionlisteners||
{},servicetaskclass:this.raw.servicetaskclass,servicetaskexpression:this.raw.servicetaskexpression,servicetaskdelegateexpression:this.raw.servicetaskdelegateexpression,servicetaskresultvariable:this.raw.servicetaskresultvariable||"",servicetaskfields:{items:this.raw.servicetaskfields?this.raw.servicetaskfields:[],totalCount:this.raw.servicetaskfields?this.raw.servicetaskfields.length:0}},stencil:{id:this.rawType},childShapes:[],outgoing:this.getOutgoing(),bounds:this.getBounds(),dockers:[]}};var StartEvent=function(a){StartEvent.superClass.constructor.call(this,a);this.rawType="StartNoneEvent";this.icon=a.icon||Icons.startEvent;this.name=a.name||Activity.startEvent};Q.inherit(StartEvent,AbstractEvent);StartEvent.create=function(a){var b={id:Quark.UIDUtil.createUID("startEvent"),autoSize:!0};Q.merge(b,a);return new StartEvent(b)};
StartEvent.prototype.rawObject=function(){return{resourceId:this.id,properties:{name:this.name,documentation:this.raw.documentation||"",formproperties:this.raw.formproperties,initiator:this.raw.initiator,formkeydefinition:this.raw.formkeydefinition||"",executionlisteners:this.raw.executionlisteners||{}},stencil:{id:this.rawType},childShapes:[],outgoing:this.getOutgoing(),bounds:this.getBounds(),dockers:[]}};
StartEvent.prototype._drawBasic=function(){this.basicPainter.visible=!0;this.basicPainter.clear();var a=this.width/2,b=this.width/2,c=this.width/2,e=this.width/2-12,i=this.height/2+3;this.basicPainter.lineStyle(1,"#007bff")._addAction(["arc",a,b,c,0,Math.PI*2,0])._addAction(["font","12px serif"])._addAction(["fillStyle","#007bff"])._addAction(["fillText","\u5f00\u59cb",e,i]).endFill()};var EndEvent=function(a){EndEvent.superClass.constructor.call(this,a);this.rawType="EndNoneEvent";this.icon=a.icon||Icons.endEvent;this.name=a.name||Activity.endEvent};Q.inherit(EndEvent,AbstractEvent);EndEvent.create=function(a){var b={id:Quark.UIDUtil.createUID("endNoneEvent"),autoSize:!0};Q.merge(b,a);return new EndEvent(b)};
EndEvent.prototype.rawObject=function(){return{bounds:this.getBounds(),outgoing:[],properties:{documentation:this.raw.documentation||"",name:this.name,executionlisteners:{totalCount:1,items:[{execution_listener_event_type:"start",execution_listener_delegate_expression:"${joaProcessEndListener}"}]}},resourceId:this.id,stencil:{id:this.rawType}}};
EndEvent.prototype._drawBasic=function(){this.basicPainter.visible=!0;this.basicPainter.clear();var a=this.width/2,b=this.width/2,c=this.width/2,e=this.width/2-12,i=this.height/2+3;this.basicPainter.lineStyle(1,"#888888")._addAction(["arc",a,b,c,0,Math.PI*2,0])._addAction(["font","12px serif"])._addAction(["fillStyle","#888888"])._addAction(["fillText","\u7ed3\u675f",e,i]).endFill()};var ParallelGateway=function(a){ParallelGateway.superClass.constructor.call(this,a);this.rawType="ParallelGateway";this.icon=a.icon||Icons.parallelGateway;this.name=a.name||Activity.parallelGateway};Q.inherit(ParallelGateway,AbstractGateway);ParallelGateway.create=function(a){var b={id:Quark.UIDUtil.createUID("parallelGateway"),autoSize:!0};Q.merge(b,a);return new ParallelGateway(b)};
ParallelGateway.prototype.rawObject=function(){return{resourceId:this.id,properties:{name:this.name,documentation:this.raw.documentation||""},stencil:{id:"ParallelGateway"},childShapes:[],outgoing:this.getOutgoing(),bounds:this.getBounds(),dockers:[]}};var ScriptTask=function(a){ScriptTask.superClass.constructor.call(this,a);this.rawType="ScriptTask";this.icon=a.icon||Icons.scriptTask;this.name=a.name||Activity.scriptTask};Q.inherit(ScriptTask,AbstractTask);ScriptTask.create=function(a){var b={id:Quark.UIDUtil.createUID("scriptTask"),width:120,height:60,autoSize:!0};Q.merge(b,a);return new ScriptTask(b)};
ScriptTask.prototype.rawObject=function(){return{resourceId:this.id,properties:{name:this.name,asynchronousdefinition:this.raw.async||"No",documentation:this.raw.documentation||"",duedatedefinition:this.raw.dueDate,exclusivedefinition:this.raw.exclusiveDefinition||"Yes",isforcompensation:this.raw.isforcompensation||"false",looptype:this.raw.looptype||"None",prioritydefinition:this.raw.priorityDefinition,executionlisteners:this.raw.executionlisteners||{},scriptformat:this.raw.scriptformat||"groovy",
scripttext:this.raw.scripttext||""},stencil:{id:this.rawType},childShapes:[],outgoing:this.getOutgoing(),bounds:this.getBounds(),dockers:[]}};var ErrorEndEvent=function(a){ErrorEndEvent.superClass.constructor.call(this,a);this.rawType="EndErrorEvent";this.icon=a.icon||Icons.errorEndEvent;this.name=a.name||Activity.errorEndEvent};Q.inherit(ErrorEndEvent,AbstractEvent);ErrorEndEvent.create=function(a){var b={id:Quark.UIDUtil.createUID("endEvent"),autoSize:!0};Q.merge(b,a);return new ErrorEndEvent(b)};
ErrorEndEvent.prototype.rawObject=function(){return{bounds:this.getBounds(),outgoing:[],properties:{documentation:this.raw.documentation||"",errorrefdefinition:{totalCounts:1,items:[{errorcode:this.raw.errorCode||"aa"}]},name:this.name},resourceId:this.id,stencil:{id:this.rawType}}};var ExclusiveGateway=function(a){ExclusiveGateway.superClass.constructor.call(this,a);this.rawType="ExclusiveGateway";this.icon=a.icon||Icons.exclusiveGateway;this.name=a.name||Activity.exclusiveGateway};Q.inherit(ExclusiveGateway,AbstractGateway);ExclusiveGateway.create=function(a){var b={id:Quark.UIDUtil.createUID("exclusiveGateway"),autoSize:!0};Q.merge(b,a);return new ExclusiveGateway(b)};
ExclusiveGateway.prototype.rawObject=function(){var a=this.getStage().context.canvas.engine,b=this.getOutgoing(),c=!1;if(b){for(var e=0;e<b.length;e++){var i=a.byId(b[e].id);if(i&&i.raw.conditionsequenceflow){c=!0;break}}if(b.length>1&&!c)throw"\u5f53\u6392\u4ed6\u7f51\u5173\u6709\u591a\u4e2a\u51fa\u53e3\u7684\u60c5\u51b5\u4e0b\uff0c\u81f3\u5c11\u4e00\u4e2a\u51fa\u53e3\u9700\u8981\u6761\u4ef6\uff01";}return{resourceId:this.id,properties:{name:this.name,documentation:this.raw.documentation||"",defaultflow:this.raw.defaultFlow},
stencil:{id:"ExclusiveGateway"},childShapes:[],outgoing:this.getOutgoing(),bounds:this.getBounds(),dockers:[]}};var SubProcess=function(a){a||(a={});a.name=a.name||Activity.subProcess;SubProcess.superClass.constructor.call(this,a);this.rawType="SubProcess"};Q.inherit(SubProcess,AbstractContainer);SubProcess.create=function(a){var b={id:Quark.UIDUtil.createUID("subProcess"),width:180,height:90,autoSize:!0,fillColor:"#fdfaea"};Q.merge(b,a);return new SubProcess(b)};
SubProcess.prototype.rawObject=function(){for(var a={bounds:this.getBounds(),childShapes:[],dockers:[],outgoing:this.getOutgoing(),properties:{documentation:this.raw.documentation||"",name:this.name,executionlisteners:this.raw.executionlisteners||{}},resourceId:this.id,stencil:{id:this.rawType}},b=this.children.slice(0),c=0;c<b.length;c++)b[c].rawType&&Utils.isFunction(b[c].rawObject)&&a.childShapes.push(b[c].rawObject());return a};var TimerEvent=function(a){TimerEvent.superClass.constructor.call(this,a);this.rawType="TimerEvent";this.icon=a.icon||Icons.timerEvent;this.name=a.name||Activity.timerEvent};Q.inherit(TimerEvent,DockableObject);TimerEvent.create=function(a){var b={id:Quark.UIDUtil.createUID("timerEvent"),autoSize:!0};Q.merge(b,a);return new TimerEvent(b)};
TimerEvent.prototype.rawObject=function(){var a=null,a=this.docked?"BoundaryTimerEvent":Utils.isFunction(this.getIngoing)&&this.getIngoing().length==0?"StartTimerEvent":"CatchTimerEvent",a={resourceId:this.id,properties:{overrideid:this.id,name:this.name,executionlisteners:this.raw.executionlisteners||{}},stencil:{id:a},childShapes:[],outgoing:this.getOutgoing(),bounds:this.getBounds(),dockers:[]};Q.merge(a.properties,this.raw);a.properties.cancelactivity=this.raw.cancelactivity===!0?"Yes":"No";return a};var ActivityAdapter=function(){};
ActivityAdapter.prototype={_extractBpmnType:function(a,b){var c=a.itemDefinitions[b.id];return c?c.itemKind:"EndEvent"},_fixType:function(a,b){if(a==="BoundaryEvent"){if(b.attachedToRefId&&b.eventDefinitions&&b.eventDefinitions.length>0&&(typeof b.eventDefinitions[0].timeDuration!="undefined"||typeof b.eventDefinitions[0].timeCycle!="undefined"||typeof b.eventDefinitions[0].timeDate!="undefined"))return"TimerEvent"}else if(a==="StartEvent"){if(b.eventDefinitions&&b.eventDefinitions.length>0&&(typeof b.eventDefinitions[0].timeDuration!=
"undefined"||typeof b.eventDefinitions[0].timeCycle!="undefined"||typeof b.eventDefinitions[0].timeDate!="undefined"))return"TimerEvent"}else if(a==="IntermediateCatchEvent")return"TimerEvent";return a},convert:function(a,b,c,e){if(a&&a.flowElements&&a.flowElements.length!=0){var i;i=e?e:c.stage;for(var j=[],g=0;g<a.flowElements.length;g++){var d=a.flowElements[g],f=b.locationMap[d.id];if(f){var h=this._extractBpmnType(b,d),h=this._fixType(h,d),m=f.x;e&&(m=f.x-e.x);var k=f.y;e&&(k=f.y-e.y);f=c._addAcitivty(h,
{id:d.id,name:d.name,x:m,y:k,width:f.width,height:f.height},i);f.raw={};f.raw.documentation=d.documentation;f.raw.defaultFlow=d.defaultFlow;f.raw.initiator=d.initiator;if(h==="UserTask"){if(f.raw.usertaskassignment={items:[]},d.assignee&&f.raw.usertaskassignment.items.push({assignment_type:"assignee",resourceassignmentexpr:d.assignee}),d.candidateUsers&&f.raw.usertaskassignment.items.push({assignment_type:"candidateUsers",resourceassignmentexpr:d.candidateUsers.join(",")}),d.candidateGroups&&f.raw.usertaskassignment.items.push({assignment_type:"candidateGroups",
resourceassignmentexpr:d.candidateGroups.join(",")}),f.raw.usertaskassignment.totalCount=f.raw.usertaskassignment.items.length,f.raw.formkeydefinition=d.formKey,f.raw.exclusivedefinition=!d.notExclusive,f.raw.asynchronousdefinition=d.asynchronous,f.raw.duedatedefinition=d.dueDate,f.raw.prioritydefinition=d.priority,d.taskListeners&&d.taskListeners.length>0){f.raw.tasklisteners={totalCount:d.taskListeners.length,items:[]};for(h=0;h<d.taskListeners.length;h++){var k=d.taskListeners[h],n={task_listener_event_type:k.event};
if(k.implementationType==="delegateExpression")n.task_listener_delegate_expression=k.implementation;else if(k.implementationType==="expression")n.task_listener_expression=k.implementation;else if(k.implementationType==="class")n.task_listener_class=k.implementation;f.raw.tasklisteners.items.push(n)}}}else if(h==="ServiceTask")if(d.implementationType==="class")f.raw.servicetaskclass=d.implementation;else if(d.implementationType==="expression")f.raw.servicetaskexpression=d.implementation;else{if(d.implementationType===
"delegateExpression")f.raw.servicetaskdelegateexpression=d.implementation}else if(h==="ScriptTask")f.raw.scripttext=d.script,f.raw.scriptformat=d.scriptFormat;else if(h==="TimerEvent")j.push({node:f,element:d});else if(h==="StartEvent")f.raw.formkeydefinition=d.formKey,f.raw.initiator=d.initiator;if(typeof d.formProperties!="undefined"&&d.formProperties.length>0)for(m in f.raw.formproperties={totalCount:d.formProperties.length,items:[]},d.formProperties)h=d.formProperties[m],f.raw.formproperties.items.push({formproperty_id:parseInt(h.id)?
parseInt(h.id):h.id,formproperty_name:h.name,formproperty_type:"",formproperty_expression:"",formproperty_variable:""});this.doExecutionListeners(d,f);d.flowElements&&d.flowElements.length>0&&this.convert(d,b,c,f)}}for(g=0;g<j.length;g++)j[g].node.raw.cancelactivity=j[g].element.cancelActivity,j[g].node.raw.timerdurationdefinition=j[g].element.eventDefinitions[0].timeDuration,j[g].node.raw.timerdatedefinition=j[g].element.eventDefinitions[0].timeDate,j[g].node.raw.timercycledefinition=j[g].element.eventDefinitions[0].timeCycle,
j[g].element.attachedToRef&&j[g].element.attachedToRefId&&(d=c.byId(j[g].element.attachedToRefId))&&j[g].node._dock(d);console.log(b);for(g=0;g<a.flowElements.length;g++)if(d=a.flowElements[g],console.log(d),f=b.flowLocationMap[d.id]){e=j=null;m=[];d.sourceRef&&(j=c.byId(d.sourceRef));d.targetRef&&(e=c.byId(d.targetRef));for(h=0;h<f.length;h++)m.push({x:f[h].x,y:f[h].y});if(j&&e){var l=c.addSequenceFlow({startNode:j,endNode:e,points:m,id:d.id},i);l.condition=d.conditionExpression;l.raw.conditionsequenceflow=
d.conditionExpression;l.raw.documentation=d.documentation;l.raw.name=d.name;l.name=d.name;l.isDefault=l.id===l.startNode.raw.defaultFlow}this.doExecutionListeners(d,l)}}},doExecutionListeners:function(a,b){if(a.executionListeners&&a.executionListeners.length>0){b.raw.executionlisteners={totalCount:a.executionListeners.length,items:[]};for(var c=0;c<a.executionListeners.length;c++){var e=a.executionListeners[c],i={execution_listener_event_type:e.event};if(e.implementationType==="delegateExpression")i.execution_listener_delegate_expression=
e.implementation;else if(e.implementationType==="expression")i.execution_listener_expression=e.implementation;else if(e.implementationType==="class")i.execution_listener_class=e.implementation;b.raw.executionlisteners.items.push(i)}}},convertRoot:function(a,b){a.raw.process_id=b.mainProcess.id;a.raw.process_namespace=b.targetNamespace||"http://www.activiti.org/processdef";a.raw.name=b.mainProcess.name||"";a.raw.documentation=b.mainProcess.documentation||"";a.raw.candidateStarterUsers=b.mainProcess.candidateStarterUsers||
"";a.raw.candidateStarterGroups=b.mainProcess.candidateStarterGroups||"";var c=a.raw.candidateStarterUsers;if(Ext.isArray(c)&&c.length>0)a.raw.candidateStarterUsers=c.join(",");c=a.raw.candidateStarterGroups;!Ext.isArray(c)&&typeof c==="string"&&(c=c.split(","));if(c&&c.length>0){for(var e=[],i=0;i<c.length;i++)isNaN(parseInt(c[i]))||e.push(parseInt(c[i]));a.raw.candidateStarterGroups=e}this.doExecutionListeners(b.mainProcess,a)},load:function(a,b){var c={};if(typeof b.processDefinitionId!="undefined"&&
b.processDefinitionId!=null)c.processDefinitionId=b.processDefinitionId;else if(typeof b.deploymentId!="undefined"&&b.deploymentId!=null)c.deploymentId=b.deploymentId;else if(typeof b.key!="undefined"&&b.key!=null)c.key=b.key;else if(typeof b.processInstanceId!="undefined"&&b.processInstanceId!=null)c.processInstanceId=b.processInstanceId;else{alert("\u6ca1\u6709\u8db3\u591f\u7684\u53c2\u6570\uff01");return}var e=this;Ext.Ajax.request({url:b.queryUrl,params:c,method:"GET",success:function(c){c=Ext.decode(c.responseText,
!0);!c||c.msg?Utils.isFunction(b.loadFailed)&&b.loadFailed(c):(a.clear(),new ActivityAdapter,e.convert(c.mainProcess,c,a),Utils.isFunction(b.loadSuccess)&&(e.convertRoot(a,c),b.loadSuccess(c)))},failure:function(a){Utils.isFunction(b.loadFailed)&&b.loadFailed(a)}})}};

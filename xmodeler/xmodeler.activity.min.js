var ActivityEngine=function(a){if(!a.menu)a.menu=new ContextMenu(this,[{className:"start-event",action:"StartEvent",text:"\u5f00\u59cb\u4e8b\u4ef6"},{className:"end-event",action:"EndEvent",text:"\u7ed3\u675f\u4e8b\u4ef6"},{className:"timer",action:"TimerEvent",text:"\u8ba1\u65f6\u5668\u4e8b\u4ef6"},{className:"user-task",action:"UserTask",text:"\u7528\u6237\u4efb\u52a1"},{className:"parallel-gateway",action:"ParallelGateway",text:"\u5e73\u884c\u7f51\u5173"},{className:"exclusive-gateway",action:"ExclusiveGateway",
text:"\u4e92\u65a5\u7f51\u5173"},{className:"connection",action:"",text:"\u8fde\u63a5\u7ebf"},{className:"subprocess",action:"SubProcess",text:"\u5b50\u6d41\u7a0b"},{className:"sp",action:"",text:""},{className:"delete",action:"",text:"\u5220\u9664"},{className:"sp",action:"",text:""},{className:"savepng",action:"saveAsImage",text:"\u5bfc\u51fa\u56fe\u7247"}]);ActivityEngine.superClass.constructor.call(this,a)};Q.inherit(ActivityEngine,Engine);
ActivityEngine.prototype.addUserTask=function(a,b){return this._addAcitivty("UserTask",a,b)};ActivityEngine.prototype.addServiceTask=function(a,b){return this._addAcitivty("ServiceTask",a,b)};ActivityEngine.prototype.addScriptTask=function(a,b){return this._addAcitivty("ScriptTask",a,b)};ActivityEngine.prototype.addSubProcess=function(a,b){return this._addAcitivty("SubProcess",a,b)};ActivityEngine.prototype.addParallelGateway=function(a,b){return this._addAcitivty("ParallelGateway",a,b)};
ActivityEngine.prototype.addExclusiveGateway=function(a,b){return this._addAcitivty("ExclusiveGateway",a,b)};ActivityEngine.prototype.addEndEvent=function(a,b){return this._addAcitivty("EndEvent",a,b)};ActivityEngine.prototype.addStartEvent=function(a,b){return this._addAcitivty("StartEvent",a,b)};ActivityEngine.prototype.addErrorEndEvent=function(a,b){return this._addAcitivty("ErrorEndEvent",a,b)};ActivityEngine.prototype.addTimerEvent=function(a,b){return this._addAcitivty("TimerEvent",a,b)};
ActivityEngine.prototype.addShadowFlow=function(a,b,c){if(b&&b.canBeConnected)a||(a={}),a.connectionCreated=function(a){a.id=Quark.UIDUtil.createUID("sequenceFlow");a.rawType="SequenceFlow";a.rawObject=SequenceFlow.prototype.rawObject},ActivityEngine.superClass.addShadowFlow.call(this,a,b,c)};ActivityEngine.prototype.addSequenceFlow=function(a){var b={x:0,y:0,autoSize:!0};Q.merge(b,a);b=SequenceFlow.create(b);a.startNode&&a.startNode.parent.addChild(b);return b};
ActivityEngine.prototype.rawObject=function(){if(!this.raw.process_id)this.raw.process_id="process";if(!this.raw.process_namespace)this.raw.process_namespace="http://www.activiti.org/processdef";for(var a={resourceId:this.id,properties:this.raw,stencil:{id:"BPMNDiagram"},bounds:{lowerRight:{x:this.width,y:this.height},upperLeft:{x:0,y:0}},stencilset:{url:"",namespace:"http://b3mn.org/stencilset/bpmn2.0#"},ssextensions:[]},b=[],c=this.stage.children.slice(0),f=0;f<c.length;f++)c[f].rawType=="SubProcess"&&
!c[f].maximized&&c[f].maximize();for(f=0;f<c.length;f++)Utils.isFunction(c[f].rawObject)&&b.push(c[f].rawObject());a.childShapes=b;b=this.getNodes();c={};for(f=0;f<b.length;f++)if(b[f]&&b[f].raw&&b[f].raw.defaultFlow)c[b[f].id]=b[f].raw.defaultFlow;a.properties.defaultFlowDefinitions=c;return a};var SequenceFlow=function(a){SequenceFlow.superClass.constructor.call(this,a);this.id=a.id||Quark.UIDUtil.createUID("sequenceFlow");this.rawType="SequenceFlow"};Q.inherit(SequenceFlow,AbstractConnection);SequenceFlow.create=function(a){return new SequenceFlow(a)};
SequenceFlow.prototype.rawObject=function(){for(var a=[],b=0;b<this.points.length;b++)b==0?a.push({x:this.startNode.width/2,y:this.startNode.height/2}):b==this.points.length-1?a.push({x:this.endNode.width/2,y:this.endNode.height/2}):a.push(this.points[b]);return{resourceId:this.id,properties:{name:this.name,documentation:this.raw.documentation||"",conditionsequenceflow:this.raw.conditionsequenceflow||"",defaultflow:this.defaultFlow||"None",conditionalflow:this.conditionFlow||"None"},stencil:{id:this.rawType},
childShapes:[],outgoing:this.getOutgoing(),bounds:this.getBounds(),dockers:a,target:{resourceId:this.endNode.id}}};var UserTask=function(a){UserTask.superClass.constructor.call(this,a);this.rawType="UserTask";this.icon=a.icon||Icons.userTask;this.name=a.name||Activity.userTask};Q.inherit(UserTask,AbstractTask);UserTask.create=function(a){var b={id:Quark.UIDUtil.createUID("userTask"),autoSize:!0};Q.merge(b,a);return new UserTask(b)};
UserTask.prototype.rawObject=function(){return{bounds:this.getBounds(),childShapes:[],dockers:[],outgoing:this.getOutgoing(),properties:{asynchronousdefinition:this.raw.asynchronousdefinition===!0?"Yes":"No",documentation:this.raw.documentation||"",duedatedefinition:this.raw.duedatedefinition,exclusivedefinition:this.raw.exclusivedefinition===!0?"Yes":"No",formkeydefinition:this.raw.formkeydefinition||"",formproperties:this.raw.formproperties,isforcompensation:this.raw.isforcompensation||"false",
looptype:this.raw.looptype||"None",name:this.name,prioritydefinition:this.raw.prioritydefinition,tasklisteners:this.raw.taskListeners||{},usertaskassignment:this.raw.usertaskassignment,defaultflow:this.raw.defaultFlow},resourceId:this.id,stencil:{id:this.rawType}}};var ServiceTask=function(a){ServiceTask.superClass.constructor.call(this,a);this.rawType="ServiceTask";this.icon=a.icon||Icons.serviceTask;this.name=a.name||Activity.serviceTask};Q.inherit(ServiceTask,AbstractTask);ServiceTask.create=function(a){var b={id:Quark.UIDUtil.createUID("serviceTask"),width:120,height:60,autoSize:!0};Q.merge(b,a);return new ServiceTask(b)};
ServiceTask.prototype.rawObject=function(){return{resourceId:this.id,properties:{asynchronousdefinition:this.raw.asynchronousdefinition||"No",documentation:this.raw.documentation||"",duedatedefinition:this.raw.dueDate,exclusivedefinition:this.raw.exclusiveDefinition||"Yes",isforcompensation:this.raw.isforcompensation||"false",looptype:this.raw.looptype||"None",name:this.name,prioritydefinition:this.raw.prioritydefinition,tasklisteners:this.raw.taskListeners||{},sexecutionlisteners:this.raw.executionlisteners||
{},servicetaskclass:this.raw.servicetaskclass,servicetaskexpression:this.raw.servicetaskexpression,servicetaskdelegateexpression:this.raw.servicetaskdelegateexpression,servicetaskresultvariable:this.raw.servicetaskresultvariable||"",servicetaskfields:{items:this.raw.servicetaskfields?this.raw.servicetaskfields:[],totalCount:this.raw.servicetaskfields?this.raw.servicetaskfields.length:0}},stencil:{id:this.rawType},childShapes:[],outgoing:this.getOutgoing(),bounds:this.getBounds(),dockers:[]}};var StartEvent=function(a){StartEvent.superClass.constructor.call(this,a);this.rawType="StartNoneEvent";this.icon=a.icon||Icons.startEvent;this.name=a.name||Activity.startEvent};Q.inherit(StartEvent,AbstractEvent);StartEvent.create=function(a){var b={id:Quark.UIDUtil.createUID("startEvent"),autoSize:!0};Q.merge(b,a);return new StartEvent(b)};
StartEvent.prototype.rawObject=function(){return{resourceId:this.id,properties:{name:this.name,documentation:this.raw.documentation||"",formproperties:this.raw.formproperties,initiator:this.raw.initiator,formkeydefinition:this.raw.formkeydefinition||""},stencil:{id:this.rawType},childShapes:[],outgoing:this.getOutgoing(),bounds:this.getBounds(),dockers:[]}};var EndEvent=function(a){EndEvent.superClass.constructor.call(this,a);this.rawType="EndNoneEvent";this.icon=a.icon||Icons.endEvent;this.name=a.name||Activity.endEvent};Q.inherit(EndEvent,AbstractEvent);EndEvent.create=function(a){var b={id:Quark.UIDUtil.createUID("endNoneEvent"),autoSize:!0};Q.merge(b,a);return new EndEvent(b)};
EndEvent.prototype.rawObject=function(){return{bounds:this.getBounds(),outgoing:[],properties:{documentation:this.raw.documentation||"",name:this.name},resourceId:this.id,stencil:{id:this.rawType}}};var ParallelGateway=function(a){ParallelGateway.superClass.constructor.call(this,a);this.rawType="ParallelGateway";this.icon=a.icon||Icons.parallelGateway;this.name=a.name||Activity.parallelGateway};Q.inherit(ParallelGateway,AbstractGateway);ParallelGateway.create=function(a){var b={id:Quark.UIDUtil.createUID("parallelGateway"),autoSize:!0};Q.merge(b,a);return new ParallelGateway(b)};
ParallelGateway.prototype.rawObject=function(){return{resourceId:this.id,properties:{name:this.name,documentation:this.raw.documentation||""},stencil:{id:"ParallelGateway"},childShapes:[],outgoing:this.getOutgoing(),bounds:this.getBounds(),dockers:[]}};var ScriptTask=function(a){ScriptTask.superClass.constructor.call(this,a);this.rawType="ScriptTask";this.icon=a.icon||Icons.scriptTask;this.name=a.name||Activity.scriptTask};Q.inherit(ScriptTask,AbstractTask);ScriptTask.create=function(a){var b={id:Quark.UIDUtil.createUID("scriptTask"),width:120,height:60,autoSize:!0};Q.merge(b,a);return new ScriptTask(b)};
ScriptTask.prototype.rawObject=function(){return{resourceId:this.id,properties:{name:this.name,asynchronousdefinition:this.raw.async||"No",documentation:this.raw.documentation||"",duedatedefinition:this.raw.dueDate,exclusivedefinition:this.raw.exclusiveDefinition||"Yes",isforcompensation:this.raw.isforcompensation||"false",looptype:this.raw.looptype||"None",prioritydefinition:this.raw.priorityDefinition,tasklisteners:this.raw.taskListeners||{},scriptlanguage:this.raw.scriptLanguage||"javascript",
script:this.raw.srcript||""},stencil:{id:this.rawType},childShapes:[],outgoing:this.getOutgoing(),bounds:this.getBounds(),dockers:[]}};var ErrorEndEvent=function(a){ErrorEndEvent.superClass.constructor.call(this,a);this.rawType="EndErrorEvent";this.icon=a.icon||Icons.errorEndEvent;this.name=a.name||Activity.errorEndEvent};Q.inherit(ErrorEndEvent,AbstractEvent);ErrorEndEvent.create=function(a){var b={id:Quark.UIDUtil.createUID("endEvent"),autoSize:!0};Q.merge(b,a);return new ErrorEndEvent(b)};
ErrorEndEvent.prototype.rawObject=function(){return{bounds:this.getBounds(),outgoing:[],properties:{documentation:this.raw.documentation||"",errorrefdefinition:{totalCounts:1,items:[{errorcode:this.raw.errorCode||"aa"}]},name:this.name},resourceId:this.id,stencil:{id:this.rawType}}};var ExclusiveGateway=function(a){ExclusiveGateway.superClass.constructor.call(this,a);this.rawType="ExclusiveGateway";this.icon=a.icon||Icons.exclusiveGateway;this.name=a.name||Activity.exclusiveGateway};Q.inherit(ExclusiveGateway,AbstractGateway);ExclusiveGateway.create=function(a){var b={id:Quark.UIDUtil.createUID("exclusiveGateway"),autoSize:!0};Q.merge(b,a);return new ExclusiveGateway(b)};
ExclusiveGateway.prototype.rawObject=function(){var a=this.getStage().context.canvas.engine,b=this.getOutgoing(),c=!1;if(b){for(var f=0;f<b.length;f++){var j=a.byId(b[f].id);if(j&&j.raw.conditionsequenceflow){c=!0;break}}if(b.length>1&&!c)throw"\u5f53\u6392\u4ed6\u7f51\u5173\u6709\u591a\u4e2a\u51fa\u53e3\u7684\u60c5\u51b5\u4e0b\uff0c\u81f3\u5c11\u4e00\u4e2a\u51fa\u53e3\u9700\u8981\u6761\u4ef6\uff01";}return{resourceId:this.id,properties:{name:this.name,documentation:this.raw.documentation||"",defaultflow:this.raw.defaultFlow},
stencil:{id:"ExclusiveGateway"},childShapes:[],outgoing:this.getOutgoing(),bounds:this.getBounds(),dockers:[]}};var SubProcess=function(a){a||(a={});a.name=a.name||Activity.subProcess;SubProcess.superClass.constructor.call(this,a);this.rawType="SubProcess"};Q.inherit(SubProcess,AbstractContainer);SubProcess.create=function(a){var b={id:Quark.UIDUtil.createUID("subProcess"),width:180,height:90,autoSize:!0,fillColor:"#fdfaea"};Q.merge(b,a);return new SubProcess(b)};
SubProcess.prototype.rawObject=function(){for(var a={bounds:this.getBounds(),childShapes:[],dockers:[],outgoing:this.getOutgoing(),properties:{documentation:this.raw.documentation||"",name:this.name},resourceId:this.id,stencil:{id:this.rawType}},b=this.children.slice(0),c=0;c<b.length;c++)b[c].rawType&&Utils.isFunction(b[c].rawObject)&&a.childShapes.push(b[c].rawObject());return a};var TimerEvent=function(a){TimerEvent.superClass.constructor.call(this,a);this.rawType="TimerEvent";this.icon=a.icon||Icons.timerEvent;this.name=a.name||Activity.timerEvent};Q.inherit(TimerEvent,DockableObject);TimerEvent.create=function(a){var b={id:Quark.UIDUtil.createUID("timerEvent"),autoSize:!0};Q.merge(b,a);return new TimerEvent(b)};
TimerEvent.prototype.rawObject=function(){var a=null,a=this.docked?"BoundaryTimerEvent":Utils.isFunction(this.getIngoing)&&this.getIngoing().length==0?"StartTimerEvent":"CatchTimerEvent",a={resourceId:this.id,properties:{overrideid:this.id,name:this.name},stencil:{id:a},childShapes:[],outgoing:this.getOutgoing(),bounds:this.getBounds(),dockers:[]};Q.merge(a.properties,this.raw);a.properties.cancelactivity=this.raw.cancelactivity===!0?"Yes":"No";return a};var ActivityAdapter=function(){};
ActivityAdapter.prototype={_extractBpmnType:function(a,b){var c=a.itemDefinitions[b.id];return c?c.itemKind:"EndEvent"},_fixType:function(a,b){if(a==="BoundaryEvent"){if(typeof b.attachedToRef!="undefined"&&typeof b.eventDefinitions!="undefined"&&b.eventDefinitions&&b.eventDefinitions.length>0&&typeof b.eventDefinitions[0].timeDuration!="undefined")return"TimerEvent"}else if(a==="StartEvent"){if(b.eventDefinitions&&b.eventDefinitions.length>0&&typeof b.eventDefinitions[0].timeDuration!="undefined")return"TimerEvent"}else if(a===
"IntermediateCatchEvent")return"TimerEvent";return a},convert:function(a,b,c,f){if(a&&a.flowElements&&a.flowElements.length!=0){var j;j=f?f:c.stage;for(var h=[],g=0;g<a.flowElements.length;g++){var d=a.flowElements[g],e=b.locationMap[d.id];if(e){var i=this._extractBpmnType(b,d),i=this._fixType(i,d),k=e.x;f&&(k=e.x-f.x);var l=e.y;f&&(l=e.y-f.y);e=c._addAcitivty(i,{id:d.id,name:d.name,x:k,y:l,width:e.width,height:e.height},j);e.raw={};e.raw.documentation=d.documentation;e.raw.defaultFlow=d.defaultFlow;
e.raw.initiator=d.initiator;if(i==="UserTask")e.raw.usertaskassignment={items:[]},d.assignee&&e.raw.usertaskassignment.items.push({assignment_type:"assignee",resourceassignmentexpr:d.assignee}),d.candidateUsers&&e.raw.usertaskassignment.items.push({assignment_type:"candidateUsers",resourceassignmentexpr:d.candidateUsers.join(",")}),d.candidateGroups&&e.raw.usertaskassignment.items.push({assignment_type:"candidateGroups",resourceassignmentexpr:d.candidateGroups.join(",")}),e.raw.usertaskassignment.totalCount=
e.raw.usertaskassignment.items.length,e.raw.formkeydefinition=d.formKey,e.raw.exclusivedefinition=!d.notExclusive,e.raw.asynchronousdefinition=d.asynchronous,e.raw.duedatedefinition=d.dueDate,e.raw.prioritydefinition=d.priority;else if(i==="ServiceTask")if(d.implementationType==="class")e.raw.servicetaskclass=d.implementation;else if(d.implementationType==="expression")e.raw.servicetaskexpression=d.implementation;else{if(d.implementationType==="delegateExpression")e.raw.servicetaskdelegateexpression=
d.implementation}else if(i==="TimerEvent")h.push({node:e,element:d});else if(i==="StartEvent")e.raw.formkeydefinition=d.formKey,e.raw.initiator=d.initiator;if(typeof d.formProperties!="undefined"&&d.formProperties.length>0)for(k in e.raw.formproperties={totalCount:d.formProperties.length,items:[]},d.formProperties)i=d.formProperties[k],e.raw.formproperties.items.push({formproperty_id:parseInt(i.id)?parseInt(i.id):i.id,formproperty_name:i.name,formproperty_type:"",formproperty_expression:"",formproperty_variable:""});
d.flowElements&&d.flowElements.length>0&&this.convert(d,b,c,e)}}for(g=0;g<h.length;g++)h[g].node.raw.cancelactivity=h[g].element.cancelActivity,h[g].node.raw.timerdurationdefinition=h[g].element.eventDefinitions[0].timeDuration,h[g].node.raw.timerdatedefinition=h[g].element.eventDefinitions[0].timeDate,h[g].node.raw.timercycledefinition=h[g].element.eventDefinitions[0].timeCycle,h[g].element.attachedToRef&&h[g].element.attachedToRefId&&(d=c.byId(h[g].element.attachedToRefId))&&h[g].node._dock(d);
for(g=0;g<a.flowElements.length;g++)if(d=a.flowElements[g],e=b.flowLocationMap[d.id]){f=h=null;k=[];d.sourceRef&&(h=c.byId(d.sourceRef));d.targetRef&&(f=c.byId(d.targetRef));for(i=0;i<e.length;i++)k.push({x:e[i].x,y:e[i].y});if(h&&f)e=c.addSequenceFlow({startNode:h,endNode:f,points:k,id:d.id},j),e.condition=d.conditionExpression,e.raw.conditionsequenceflow=d.conditionExpression,e.raw.documentation=d.documentation,e.raw.name=d.name,e.name=d.name,e.isDefault=e.id===e.startNode.raw.defaultFlow}}},convertRoot:function(a,
b){a.raw.process_id=b.mainProcess.id;a.raw.process_namespace=b.targetNamespace||"http://www.activiti.org/processdef";a.raw.name=b.mainProcess.name||"";a.raw.documentation=b.mainProcess.documentation||"";a.raw.candidateStarterUsers=b.mainProcess.candidateStarterUsers||"";a.raw.candidateStarterGroups=b.mainProcess.candidateStarterGroups||"";var c=a.raw.candidateStarterUsers;if(Ext.isArray(c)&&c.length>0)a.raw.candidateStarterUsers=c.join(",");c=a.raw.candidateStarterGroups;!Ext.isArray(c)&&typeof c===
"string"&&(c=c.split(","));if(c&&c.length>0){for(var f=[],j=0;j<c.length;j++)isNaN(parseInt(c[j]))||f.push(parseInt(c[j]));a.raw.candidateStarterGroups=f}},load:function(a,b){var c={};if(typeof b.processDefinitionId!="undefined"&&b.processDefinitionId!=null)c.processDefinitionId=b.processDefinitionId;else if(typeof b.deploymentId!="undefined"&&b.deploymentId!=null)c.deploymentId=b.deploymentId;else if(typeof b.key!="undefined"&&b.key!=null)c.key=b.key;else if(typeof b.processInstanceId!="undefined"&&
b.processInstanceId!=null)c.processInstanceId=b.processInstanceId;else{alert("\u6ca1\u6709\u8db3\u591f\u7684\u53c2\u6570\uff01");return}var f=this;Ext.Ajax.request({url:b.queryUrl,params:c,method:"GET",success:function(c){c=Ext.decode(c.responseText,!0);!c||c.msg?Utils.isFunction(b.loadFailed)&&b.loadFailed(c):(a.clear(),new ActivityAdapter,f.convert(c.mainProcess,c,a),Utils.isFunction(b.loadSuccess)&&(f.convertRoot(a,c),b.loadSuccess(c)))},failure:function(a){Utils.isFunction(b.loadFailed)&&b.loadFailed(a)}})}};
